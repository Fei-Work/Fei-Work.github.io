---
title: "SLAM-旋转01：欧拉角与旋转矩阵"

categories:
  - blogs
tags:
  - Pose
  - SLAM
lang: zh
header: 
  teaser: "./assets/images/Rotation01/image-20241116220715875.png"
---


在机器人定位中，我们一般使用旋转与平移来表示机器人的位姿(位置与姿态)，这是很基础的知识。如果这个部分不搞通透，就算只是调包，搞不清楚几个坐标系之间的变换关系工作效率也会大大降低。平移（位置）就是使用一个在笛卡尔坐标系下的三维坐标表示，这可能是初中甚至更低水平的数字知识。所以真正需要补充的是三维空间下的旋转（姿态）的表达方式。

在入门阶段，很多入门教程如《十四讲》等都已经讲的很清楚了，关于旋转矩阵、四元数、轴角、欧拉角、以及噩梦般的李代数，以及他们之间的相互转化关系的推导。但在我实际进行定位建图的过程中，发现其实这么多表示方式的转化关系基本都只需要调用`Eigen`或者`tf`库中的函数就可以解决了，

在项目中最常提及到的反而是有万向锁问题的欧拉角，因为使用欧拉角理解旋转对于人类而言真的非常直观，你给工地上的大爷提一嘴他都懂你意思。最需要防备的是不同坐标系下的相对位姿，因为真的很容易搞混。最需要沉淀下去学习的是关于流形、群、李代数的相关数学知识，因为相信我们不会只满足做个可爱的调包侠(*即使我会调包我也骄傲：cry*)。

虽然很基础，但是真的是建筑的底层，那么再推一遍，作此记录。

## 从欧拉角开始

不同与《十四讲》的顺序，这里从欧拉角出发，因为欧拉角确实是最直观表示旋转的方式。欧拉角就是分别绕三个坐标轴ZYX旋转的角：Yaw(偏航角)、Pitch（俯仰角）、Roll（横滚角），但需要注意的是**转轴的顺序要固定**，因为每次旋转都是相对与旋转后的轴再旋转的。如下图，这里演示的就是ZYX。

{% include image.html url="/assets/images/Rotation01/image-20241116205745249.png" description="" %}

#### 万向锁

提到欧拉角，脑袋里第一个蹦出来的就是**万向锁**（Gimbal Lock）问题，可能因为我空间感很差，所以自己拿个模型转半天没看出来什么问题，搜了些视频感觉即使播放量很高但是说的也似乎不太清楚。直到看到平衡环架的演示才对这个过程有了认识，以及[b站视频](https://www.bilibili.com/video/BV1Nr4y1j7kn)**下面的yyhhhyeah的高赞评论**，这里我有找出来引用一下：

>“说了一大堆，其实就是在说一件事：欧拉角描述相对于初始状态的变换，只和最终状态有关，与过程无关。 ”
>
>“所谓的万向死锁，这个名字很具有误导性，听起来像是欧拉角这种描述方式存在巨大缺陷一样。其本质就是：物体角度状态与欧拉角坐标并非一一对应关系。某些位置状态并不唯一确定一组欧拉角坐标”

#### 为什么不是绕两个轴旋转就可以了

我们知道三维空间旋转有三个自由度，那么至少需要三个参数这是铁的事实了，所以这个问题其实并不是问题，仍然是我的空间想象能力作祟。

“对于平面坐标系，很显然绕一个轴转就可以表示出所有的旋转状态了，转一圈一个轴就画成了一个圆；那么拓展到三维空间，只要画一个球壳就可以了指向所有的方位了，然后我发现其实通过绕两个轴的旋转就可以覆盖到球面“，于是大脑想象与理论冲突，我一直在想象可以用两个个轴旋转出所有的指向姿态，即使我知道这并不正确。

这其实是个很蠢的问题，直到现在我都不理解为啥当时我会把它具象化到一个球壳上，破解的方法真的很简单，除了指向球面的轴我们还剩下两个轴，试问指向球面后的物体翻滚如何解决呢。嗯，问题解决了。



## 从欧拉角到旋转矩阵

在写参数配置文件时，我喜欢让程序去读一个欧拉角，因为很直观我可以理解各个传感器之间的外参状态，之后代码文件引入参数后再转化为`Eigen`的旋转矩阵格式，再做后续的处理。那么再简单推导下从欧拉角到旋转矩阵的公式。为了节省精力，写二维的来推导，假设有一个点 $P(x,y)$，从一个车体坐标系$O$转化到另一个世界坐标系$W$：$\varphi$为从W向O旋转的角度，$r$为点到原点的距离，$\theta$为点与车体坐标系$O$坐标轴$X$的夹角。

{% include image.html url="/assets/images/Rotation01/image-20241116220715875.png" description="" %}

$$
x_w = r\cos(\varphi + \theta) \\
y_w = r\sin(\varphi + \theta) \tag {1}
$$

展开：

$$
x_w = x_o\cos(\varphi) - y_o\sin(\varphi) \\
y_w = x_o\sin(\varphi) + y_o\cos(\varphi) 
\tag {2}
$$

即：

$$
\begin{bmatrix}
   x_w \\
   y_w \\
 \end{bmatrix}
  = \begin{bmatrix}
   \cos(\varphi) & -\sin(\varphi) \\
   \sin(\varphi) & \cos(\varphi) \\
  \end{bmatrix}
  \begin{bmatrix}
   x_o \\
   y_o \\
 \end{bmatrix}\tag{3}
$$

中间的项就是旋转矩阵$R_{wo}$，即从车体坐标系$O$到世界坐标系$W$的旋转关系，将该旋转矩阵$R_{wo}$与平移向量$t_{wo}$结合起来，可以描述车体坐标系$O$相对于世界坐标系的位姿。

拓展到三维的情况，根据我们之前提到的欧拉角的定义:

- 绕$z$轴旋转角度$\alpha $（Yaw），对应旋转矩阵：

$$
R_z(\alpha) =    \begin{bmatrix}       \cos\alpha & -\sin\alpha & 0 \\       \sin\alpha & \cos\alpha & 0 \\       0 & 0 & 1   \end{bmatrix} \tag{4}
$$

- 绕$y$轴旋转角度$\beta$（Pitch），对应旋转矩阵：

$$
R_y(\beta) =    \begin{bmatrix}       \cos\beta & 0 & \sin\beta \\       0 & 1 & 0 \\       -\sin\beta & 0 & \cos\beta   \end{bmatrix}\tag{5}
$$

- 绕 $x$轴旋转角度$\gamma$（Roll），对应旋转矩阵：

$$
R_x(\gamma) =    \begin{bmatrix}       1 & 0 & 0 \\       0 & \cos\gamma & -\sin\gamma \\       0 & \sin\gamma & \cos\gamma   \end{bmatrix}\tag{6}
$$

 以及旋转矩阵**乘法封闭性**进行**连乘**即可从欧拉角得到旋转矩阵：
 
$$
R = R_z(\alpha) \cdot R_y(\beta) \cdot R_x(\gamma) \tag{7}
$$

《十四讲》是从线性代数单位正交基一步步推导旋转矩阵以及旋转矩阵的各个性质的，这里不再重复该过程。关于旋转矩阵我们需要谨记的是其**正交性**（$R^TR=I$），且**行列式为1**，这些性质可以在$式(4)(5)(6)(7)$中得以验证。为什么说这些性质很重要，是因为它与后续群的概念密不可分。

但其实，用以上我们所说两种方案表示旋转似乎已经很完美了，欧拉角帮助我们直观的具象化旋转，旋转矩阵给我们提供了乘法封闭的旋转表示形式与数学计算规则，其它方式存在的意义又是什么呢？主要的原因是加法不封闭且需要严格满足单位正交的旋转矩阵在数值优化中处理起来很复杂，一种常用方法是使用李代数或者四元数来表示旋转。它们不需要显式满足正交约束，求导更为简单，更易于在优化问题中使用。同时，李代数和四元数也能够紧凑高效地编码旋转信息，计算效率较高。

所以说需要求导的优化问题中,更适合使用李代数或四元数这样的表示方式。它们在保留旋转信息的同时,也具有更好的可导性和计算效率



